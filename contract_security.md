<h1 align="center">合约安全</h1>

## 常见的攻击手段

### Double Spending Attack 双花攻击

双花是指利用加密货币的数字特性来实现 “一笔钱花两次”。双花不会产生新的 Token，但能把自己花出去的钱重新拿回来。

双花攻击的表现形式主要有三种：

#### Race Attack：

控制gas fee来实现双花：

攻击者同时向网络中发送两比交易，一笔是发送给自己的，附以足够高的gas费用，另外一笔是发送给商家的。发送给自己的交易由于gas较高，被矿工打包的几率较大，发送给商家的交易会被回滚。

#### Finney Attack

控制区块的广播时间实现双花：

攻击对象为接受0确认的商家。攻击者挖到区块后，区块中包含一笔自己A向自己B转账的一笔交易。攻击者不立即广播这个区块，找到一个愿意接受0确认的商家，向商家购买物品，用地址A向商家C转账。包含A -> C交易的广播出去后，攻击者立即将之前挖到的区块广播出去。A -> B的时间早于 A -> C 的时间，商家C将一无所获。

#### Vector76 attack

交易确认一次后仍然可以回滚，是 `Finney Attack` 和 `Race Attack` 的组合。

攻击对象为接受1次确认的商家。

攻击者创建两个节点，节点 A 连接到商家节点，节点 B 连接到区块链网络中的其他节点。接着，攻击者用同一笔 Token 发起两笔交易，一笔交易发送给商家地址，我们称为交易 1；一笔交易发送给自己的钱包地址，我们称为交易 2。与上面说的 Race Attack 一样，攻击者对交易 2 添加了较高的矿工费从而提高了矿工的打包概率，此时，攻击者并没有把这两笔交易广播到网络中去。

接着，攻击者开始在交易 1 所在的分支上进行挖矿，这条分支我们命名为分支 1。攻击者挖到区块后，并没有广播出去，而是同时做了两件事：在节点 A 上发送交易 1，在节点 B 上发送交易 2。

由于节点 A 只连接了商家节点，所以当商家节点想把交易 1 传给其它对等节点时，连接了更多节点的节点 B，已经把交易 2 广播给了网络中的大部分节点。于是，从概率上来讲，交易 2 就更有可能被网络认定为是有效的，交易 1 被认定为无效。

交易 2 被认为有效后，攻击者立即把自己之前在分支 1 上挖到的区块，广播到网络中。这时候，这个接受一次确认就支付的商家，会确认交易成功，然后攻击者就可以立即变现并转移资产。

同时，由于分支 2 连接的更多节点，所以矿工在这个分支上挖出了另一个区块，也就是分支 2 的链长大于分支 1 的链长。于是，分支 1 上的交易就会回滚，商家之前支付给攻击者的交易信息就会被清除，但是攻击者早已经取款，实现了双花。

### 51% attack

攻击者占有超过全网 50% 的算力，在攻击者控制算力的这段时间，他可以创造一条高度大于原来链的新链。那么旧链中的交易会被回滚，攻击者可以使用同一笔 Token 发送一笔新的交易到新链上。

### Alien Attack 异形攻击

异形攻击又称地址池污染，常常发生在兼容以太坊的公链上。以太坊兼容链，由于使用了兼容的握手协议，无法区分节点是否属于同个链，利用这一点，攻击者先对以太坊节点地址进行收集并进行恶意握手操作，通过跟节点握手达成污染地址池的目的，使得不同链的节点互相握手并把各自地址池里已知的节点推送给了对方，导致更多的节点互相污染，最终扩散致整个网络。

### Phishing 钓鱼攻击

攻击者伪装成可以信任的人或机构，通过电子邮件、通讯软件、社交媒体等方式，以获取收件人的用户名、密码、私钥等私密信息。

### Trojan Horse Attack 特洛伊木马攻击

攻击者通过隐藏在正常程序中的一段具有特殊功能的恶意代码，如具备破坏和删除文件、发送密码、记录键盘和 DDoS 攻击等特殊功能的后门程序，将控制程序寄生于被控制的计算机系统中，里应外合，对被感染木马病毒的计算机实施操作。可用来窃取用户个人信息，甚至是远程控制对方的计算机而加壳制作，然后通过各种手段传播或者骗取目标用户执行该程序，以达到盗取密码等各种数据资料等目的。

### Supply Chain Attack 供应链攻击

可以通俗地理解为在依赖包里下毒。

由于现在的软件工程，各种包/模块的依赖十分频繁、常见，而开发者们很难做到一一检查，默认都过于信任市面上流通的包管理器，这就导致了供应链攻击几乎已经成为必选攻击之一。把这种攻击称成为供应链攻击，是为了形象说明这种攻击是一种依赖关系，一个链条，任意环节被感染都会导致链条之后的所有环节出问题。

### Roll Back Attack 回滚攻击

将已经发生的交易变成未发生的状态。即攻击者本来已经发生了支付动作，但是通过某些手段，让转账流程发生错误，从而回滚整个交易流程，达到交易回滚的目的，这种攻击手法多发于区块链上的的智能合约游戏当中，当用户的下注动作和合约的开奖动作在一个交易内的时候，即内联交易。攻击者就可以通过交易发生时检测智能合约的某些状态，获知开奖信息，根据开奖信息选择是否对下注交易进行回滚。

### Random Number Attack 随机数攻击

针对智能合约的随机数生成算法进行攻击，预测智能合约的随机数。目前区块链上很多游戏都是采用的链上信息（如区块时间，未来区块哈希等）作为游戏合约的随机数源，也称随机数种子。使用这种随机数种子生成的随机数被称为伪随机数。伪随机数不是真的随机数，存在被预测的可能。当使用可被预测的随机数种子生成随机数的时候，一旦随机数生成的算法被攻击者猜测到或通过逆向等其他方式拿到，攻击者就可以根据随机数的生成算法预测游戏即将出现的随机数，实现随机数预测，达到攻击目的。

[随机数攻击代码演示](./security/src/rand_num_attack.sol)

### Replay Attack 重放攻击

针对区块链上的交易信息进行重放。区块链为了保证不可篡改，防范双花攻击，需要对交易进行验证，包括txid, nonce, timestamp等等。验证用户交易的场景随着DEX的发展变得越来越多，在智能合约中需要验证用户的签名。用户的签名是上链的，攻击者可以拿到用户签名。

如果对交易的验证不包含时间戳，nonce等变量，攻击者就可以拿着用户签名重放多次交易以获利。

### Reentrancy Attack 重入攻击

重入攻击在所有的智能合约漏洞中，危害最严重，发生频率最高。

重入攻击最经典的例子是The DAO 攻击。由于项目方采用的转账模型为先给用户发送转账然后才对用户的余额状态进行修改，导致恶意用户可以构造恶意合约，在接受转账的同时再次调用项目方的转账函数。利用这样的方法，导致用户的余额状态一直没有被改变，却能一直提取项目方资金，最终导致项目方资金被耗光。The DAO损失的以太币金额占到项目筹集的三分之一。这次攻击影响深远，引发了以太坊的硬分叉。

开发者在进行智能合约开发时，在处理转账等关键操作的时候，如果智能合约中存储了用户的资金状态，要先对资金状态进行修改，然后再进行实际的资金转账，避免重入攻击。

### Integer Overflow Attack 整数溢出攻击

整数溢出就是向存储整数的内存单位中存放的数据，超过了该内存单位所能存储的最大值，从而导致了向上溢出。

比如，我们要把整数1024赋值给一个uint8的变量，那么就会导致整数溢出，因为uint8变量能存放的最大值才是255。

由整数溢出引发的程序漏洞就称为“整数溢出漏洞”，它常常被攻击者利用。在智能合约领域，发生过多起严重事件。

2018年4月23日，一款名为BEC的代币遭到攻击。黑客利用智能合约的漏洞，向外部账户转出了天价的合约代币，数量为2的256方减1，远超它的发行量。最终，使得BEC的价格直接归零。

2018年4月25日， 代币SMT再次爆出整数溢出漏洞，又被转走天量SMT。

随后，著名的安全公司派盾PeckShield，利用自动化系统扫遍了以太坊智能合约，并对它们进行了分析。结果发现，有12个ERC-20智能合约都存在着整数溢出漏洞，很多是在交易所上正在进行交易的币种。

解决整型溢出漏洞的方法很简单，几行代码就可以搞定。 如果智能合约使用Solidity 0.8.0之前的版本开发，可以引入OpenZeppelin的Safe Math库，进行数学计算。SafeMath库的代码量不大，也可以复制到自己的智能合约中，直接使用。

Solidity 0.8.0之后的版本，编译器内部默认集成了SafeMath库。因此，直接使用Solidity默认的数学运算符，就可以避免整型溢出漏洞，无需特殊处理了。

### Sybil Attack 女巫攻击

传闻中女巫是一个会魔法的人，一个人可以幻化出多个自己，令受害人以为有多人，但其实只有一个人。女巫攻击(Sybil Attack)是针对服务器节点的攻击。攻击发生时候，通过某种方式，某个恶意节点可以伪装成多个节点，对被攻击节点发出链接请求，达到节点的最大链接请求，导致节点没办法接受其他节点的请求，造成节点拒绝服务攻击。

### Transaction-Ordering Attack 交易顺序攻击

一笔交易内可能含有多个不同的交易，而这些交易执行的顺序会影响最终的交易的执行结果，由于在挖矿机制的区块链中，交易未被打包前都处于一种待打包的 pending 状态，如果能事先知道交易里面执行了哪些其他交易，恶意用户就能通过增加矿工费的形式，发起一笔交易，让交易中的其中一笔交易先行打包，扰乱交易顺序，造成非预期内的执行结果，达成攻击。

### Short Address Attack 短地址攻击

短地址攻击(Short Address Attack)是针对以太坊上 ERC20 智能合约的一种攻击形式，利用的是 EVM 中的对于输入字节码的自动补全机制进行攻击。

### Self-destruct 自毁函数攻击
自毁函数是由以太坊虚拟机 EVM 提供的一项功能，用于销毁区块链上部署的智能合约。 当合约执行自毁操作时，合约账户上剩余的 ETH 会发送给指定的目标地址，然后其存储和代码从以太坊状态中被移除。 自毁函数在 solidity 中定义为 selfdestruct。

自毁函数使用了EVM的底层命令，是强制执行的。

自毁函数攻击经典案例是“幸运七合约”[代码演示](./security/src/selfdestruct_attack.sol)

